############################
# Stage 1: build
############################
FROM golang:1.24-alpine AS builder

WORKDIR /app

# Copia go.mod/sum primeiro para cache mais eficiente
COPY go.mod ./
RUN --mount=type=cache,target=/go/pkg/mod \
    go mod download

# Copia o restante do código
COPY . ./

# Compila binário estático para Linux
RUN --mount=type=cache,target=/go/pkg/mod \
    CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
    go build -ldflags="-s -w" -o /out/healthcheck-exporter ./main.go

############################
# Stage 2: runtime
############################
# Distroless estático (não-root) com certificados
FROM gcr.io/distroless/static:nonroot

# Porta padrão do exporter
EXPOSE 8080

# Copia o binário
COPY --from=builder /out/healthcheck-exporter /healthcheck-exporter

USER nonroot:nonroot
ENTRYPOINT ["/healthcheck-exporter"]
