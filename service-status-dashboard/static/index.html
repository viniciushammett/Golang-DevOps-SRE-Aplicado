<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <title>Service Status Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      <style>
      :root {
        --bg: #0f172a;
        --card: #111827;
        --ok: #16a34a;
        --bad: #ef4444;
        --text: #e5e7eb;
        --muted: #94a3b8;
        --chip: #1f2937;
        --chip-border: #334155;
      }
      :root[data-theme="light"] {
        --bg: #f7fafc;
        --card: #ffffff;
        --ok: #166534;
        --bad: #b91c1c;
        --text: #111827;
        --muted: #475569;
        --chip: #f1f5f9;
        --chip-border: #cbd5e1;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
        background: radial-gradient(1200px 500px at 50% -10%, var(--card) 0%, var(--bg) 60%);
        color: var(--text);
        transition: background .2s ease, color .2s ease;
      }
      header {
        padding: 24px;
        display: flex; justify-content: space-between; align-items: center; gap: 12px;
      }
      h1 { margin: 0; font-size: 20px; letter-spacing: .5px; }
      .muted { color: var(--muted); font-size: 14px; }
      .container { padding: 16px 24px 32px; max-width: 1100px; margin: 0 auto; }
      .grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
      .card {
        background: linear-gradient(180deg, var(--card), rgba(11,18,32,.95));
        border: 1px solid var(--chip-border);
        border-radius: 16px; padding: 16px;
        box-shadow: 0 10px 30px rgba(2,6,23,0.15), inset 0 1px 0 rgba(255,255,255,0.02);
      }
      .row { display: flex; justify-content: space-between; gap: 8px; align-items: baseline; }
      .name { font-weight: 600; }
      .url { color: var(--muted); font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
      .status { font-size: 12px; padding: 4px 10px; border-radius: 999px; border: 1px solid var(--chip-border); background: var(--chip); }
      .status.ok { color: #bbf7d0; border-color: #14532d; background: #052e16; }
      .status.bad { color: #fecaca; border-color: #7f1d1d; background: #2a0c0c; }
      :root[data-theme="light"] .status.ok { color: #065f46; background: #d1fae5; }
      :root[data-theme="light"] .status.bad { color: #7f1d1d; background: #fee2e2; }
      .meta { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
      .chip { font-size: 12px; padding: 4px 8px; border-radius: 8px; border: 1px solid var(--chip-border); background: var(--chip); color: var(--muted); }
      footer { text-align: center; padding: 24px; color: var(--muted); font-size: 12px; }
      .last-update { font-size: 12px; color: var(--muted); }
      .title-right { font-size: 12px; color: var(--muted); display: flex; align-items: center; gap: 12px; }
      .btn {
        font-size: 12px; padding: 6px 10px; border-radius: 10px; border: 1px solid var(--chip-border);
        background: var(--chip); color: var(--text); cursor: pointer;
      }
</style>

    </style>
  </head>
  <body>
    <header>
      <h1>Service Status Dashboard</h1>
      <div class="title-right">
        Atualiza a cada <span id="interval">5s</span>
      </div>
    </header>

    <div class="container">
      <div id="grid" class="grid"></div>
      <p class="last-update" id="lastUpdate"></p>
    </div>

    <footer>Feito com Go üêπ</footer>

    <script>
    // Tema: persist√™ncia simples
      const root = document.documentElement;
      const themeLabel = document.getElementById('themeLabel');
      const saved = localStorage.getItem('ssd_theme');
      if (saved === 'light') {
        root.setAttribute('data-theme', 'light');
        themeLabel.textContent = 'Light';
      }
      document.getElementById('themeToggle').addEventListener('click', () => {
        const current = root.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        if (current === 'light') {
          root.setAttribute('data-theme', 'light');
          themeLabel.textContent = 'Light';
          localStorage.setItem('ssd_theme', 'light');
        } else {
          root.removeAttribute('data-theme');
          themeLabel.textContent = 'Dark';
          localStorage.setItem('ssd_theme', 'dark');
        }
      });
  const POLL_MS = 5000; // fallback se SSE n√£o estiver dispon√≠vel

  async function fetchStatusOnce() {
    const res = await fetch('/status', { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP '+res.status);
    return res.json();
  }

  function renderPayload(payload) {
    const items = payload.services || payload; // compat: payload antigo (array)
    render(items);
    const info = document.getElementById('lastUpdate');
    if (payload.last_updated) {
      info.textContent = '√öltima atualiza√ß√£o: ' + new Date(payload.last_updated).toLocaleString();
    } else {
      info.textContent = 'Atualizado (fallback polling): ' + new Date().toLocaleString();
    }
  }

  function render(items) {
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    items.forEach(svc => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="row">
          <div class="name">${escapeHtml(svc.name)}</div>
          <div class="status ${svc.up ? 'ok' : 'bad'}">${svc.up ? 'UP' : 'DOWN'}</div>
        </div>
        <div class="url">${escapeHtml(svc.url)}</div>
        <div class="meta">
          <div class="chip">HTTP: ${svc.status_code ?? '-'}</div>
          <div class="chip">lat√™ncia: ${svc.latency_ms ?? '-'}ms</div>
          <div class="chip">checado: ${escapeHtml(svc.checked_at ?? '-')}</div>
          ${svc.error ? `<div class="chip">erro: ${escapeHtml(svc.error)}</div>` : ''}
        </div>
      `;
      grid.appendChild(card);
    });
  }

  function escapeHtml(s) {
    if (s == null) return '';
    return s.replace(/[&<>"']/g, c => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[c]));
  }

  // ====== Preferir SSE ======
  if ('EventSource' in window) {
    const es = new EventSource('/events');
    es.onmessage = (evt) => {
      try {
        const payload = JSON.parse(evt.data);
        renderPayload(payload);
      } catch (e) {
        console.error('SSE parse error:', e);
      }
    };
    es.onerror = (e) => {
      console.warn('SSE falhou, caindo para polling...', e);
      es.close();
      startPolling();
    };
  } else {
    // sem suporte a SSE ‚Üí polling
    startPolling();
  }

  function startPolling() {
    fetchStatusOnce().then(renderPayload).catch(console.error);
    setInterval(() => {
      fetchStatusOnce().then(renderPayload).catch(console.error);
    }, POLL_MS);
  }
    </script>
  </body>
</html>
